<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microsoft Teams ME Action WebView</title>

    <script src="https://res.cdn.office.net/teams-js/2.26.0/js/MicrosoftTeams.min.js"
            integrity="sha384-gqPg5qCjdUgTGRZ/stLskrnJllL5h5+f4kTqvxVqtl2FdT7PVRa9Q7zq4gFlZ7bO"
            crossorigin="anonymous"></script>

    <style src="../style/DragAndDropFiles.css"></style>

    <script>
        let mediaData = []; // Array to store media details
        let completedFiles = 0; // Counter for completed progress

        function enableUploadButton() {
            const uploadBtn = document.getElementById("uploadBtn");
            if (completedFiles === mediaData.length) {
                uploadBtn.classList.add("enabled");
                uploadBtn.disabled = false;
            }
        }

        microsoftTeams.initialize(() => {
            console.log("Custom Form Loaded");

            microsoftTeams.getContext((context) => {
                console.log(`Context is ${JSON.stringify(context)}`);

                let inputthreadId = context.teamId;
                if (microsoftTeams.thirdPartyCloudStorage && microsoftTeams.thirdPartyCloudStorage.getDragAndDropFiles) {
                    try {
                        microsoftTeams.thirdPartyCloudStorage.getDragAndDropFiles(inputthreadId, (medias, err) => {
                            if (err) {
                                console.error(err);
                                return;
                            }
                            const mediaTableBody = document.querySelector("#mediaTable tbody");
                            medias.forEach((media) => {
                                // Create a new row
                                const row = document.createElement("tr");

                                // Column: Media Name
                                const nameCell = document.createElement("td");
                                nameCell.textContent = media.name;
                                row.appendChild(nameCell);

                                // Column: Progress Bar
                                const progressCell = document.createElement("td");
                                const progressBar = document.createElement("div");
                                progressBar.className = "progress-bar";
                                const progressFill = document.createElement("div");
                                progressFill.className = "progress-fill";
                                progressBar.appendChild(progressFill);
                                progressCell.appendChild(progressBar);
                                row.appendChild(progressCell);

                                // Column: Status (Success Tick Mark)
                                const statusCell = document.createElement("td");
                                statusCell.style.textAlign = "center";
                                statusCell.textContent = ""; // Initially empty
                                row.appendChild(statusCell);

                                // Append row to table
                                mediaTableBody.appendChild(row);

                                // Store media details in mediaData array
                                mediaData.push({
                                    name: media.name,
                                    type: media.type,
                                    size: media.size,
                                });

                                // Simulate progress for demonstration purposes
                                let progress = 0;
                                const interval = setInterval(() => {
                                    progress += 10;
                                    progressFill.style.width = `${progress}%`;

                                    if (progress >= 100) {
                                        clearInterval(interval);
                                        progressFill.style.backgroundColor = "green"; // Change color to green
                                        statusCell.textContent = "âœ”"; // Add success tick mark
                                        statusCell.style.color = "green"; // Style the tick mark

                                        // Increment completed files and check if all are done
                                        completedFiles++;
                                        enableUploadButton();
                                    }
                                }, 500);
                            });
                        });
                    } catch (error) {
                        console.error(error);
                    }
                } else {
                    console.error("getDragAndDropFiles API is not available in the SDK.");
                }
            });
        });

        function validateForm() {
            if (!document.getElementById("uploadBtn").classList.contains("enabled")) {
                alert("Please wait until all files are processed.");
                return false;
            }
            microsoftTeams.initialize();
            console.log("Submitting the following data:", mediaData);
            microsoftTeams.tasks.submitTask(mediaData);
            return false; // Prevent default form submission
        }
    </script>
</head>
<body>
<div class="surface theme-light">
    <div class="panel">
        <form id="empForm" onsubmit="return validateForm()">
            <div id="fileList">
                <table id="mediaTable">
                    <thead>
                    <tr>
                        <th>Media Name</th>
                        <th>Progress</th>
                        <th>Status</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- Rows will be added dynamically here -->
                    </tbody>
                </table>
            </div>
            <div class="button-container">
                <input type="submit" id="uploadBtn" value="Upload" disabled>
            </div>
        </form>
    </div>
</div>
</body>
</html>
